<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quorra SIEM - IP Blocklist</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #fff;
            min-height: 100vh;
        }
        
        .blocklist-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            margin-bottom: 15px;
        }
        
        .ip-badge {
            font-family: monospace;
            background: rgba(220, 53, 69, 0.2);
            border: 1px solid rgba(220, 53, 69, 0.3);
            padding: 5px 10px;
            border-radius: 5px;
            display: inline-block;
        }
        
        .empty-state {
            text-align: center;
            padding: 50px 20px;
        }
        
        .empty-state i {
            font-size: 4rem;
            opacity: 0.3;
            margin-bottom: 20px;
        }
        
        .live-badge {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">
                <i class="fas fa-shield-alt me-2"></i>
                <span class="fw-bold">QUORRA SIEM</span>
                <span class="badge bg-primary ms-2">v1.0</span>
                <span class="badge bg-success ms-2 live-badge">LIVE</span>
            </a>
            
            <div class="navbar-nav flex-row align-items-center">
                <span class="text-light me-3">
                    <i class="fas fa-user-circle me-1"></i>
                    {{ username }}
                </span>
                <a class="nav-link mx-3" href="/dashboard">
                    <i class="fas fa-chart-line me-1"></i> Dashboard
                </a>
                <a class="nav-link mx-3" href="/logs">
                    <i class="fas fa-list me-1"></i> Logs
                </a>
                <a class="nav-link mx-3" href="/attacks">
                    <i class="fas fa-bug me-1"></i> Attacks
                </a>
                <a class="nav-link mx-3" href="/alerts">
                    <i class="fas fa-bell me-1"></i> Alerts
                </a>
                <a class="nav-link mx-3 active" href="/blocklist">
                    <i class="fas fa-ban me-1"></i> Blocklist
                </a>
                <a class="nav-link mx-3 text-warning" href="/login">
                    <i class="fas fa-sign-out-alt me-1"></i> Logout
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container-fluid py-4">
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <h1 class="h3 mb-0">
                        <i class="fas fa-ban me-2"></i>IP Blocklist
                    </h1>
                    <button class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#addBlockModal">
                        <i class="fas fa-plus me-1"></i> Add IP to Blocklist
                    </button>
                </div>
                <p class="text-muted mb-0">Manage blocked IP addresses</p>
            </div>
        </div>
        
        <!-- Statistics -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="blocklist-card p-3 text-center">
                    <div class="display-6 fw-bold text-danger" id="totalBlocked">0</div>
                    <div class="text-muted">Total Blocked IPs</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="blocklist-card p-3 text-center">
                    <div class="display-6 fw-bold text-warning" id="autoBlocked">0</div>
                    <div class="text-muted">Auto-Blocked</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="blocklist-card p-3 text-center">
                    <div class="display-6 fw-bold text-info" id="todayBlocked">0</div>
                    <div class="text-muted">Blocked Today</div>
                </div>
            </div>
        </div>
        
        <!-- Blocklist Table -->
        <div class="row">
            <div class="col-12">
                <div class="blocklist-card p-3">
                    <div class="table-responsive">
                        <table class="table table-dark table-hover" id="blocklistTable">
                            <thead>
                                <tr>
                                    <th>IP Address</th>
                                    <th>Reason</th>
                                    <th>Blocked By</th>
                                    <th>Blocked At</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="blocklistBody">
                                <tr>
                                    <td colspan="5" class="text-center py-5">
                                        <div class="spinner-border text-light" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                        <p class="mt-3">Loading blocklist...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="empty-state" id="emptyState" style="display: none;">
                        <i class="fas fa-ban"></i>
                        <h4 class="text-muted">No Blocked IPs</h4>
                        <p class="text-muted">No IP addresses are currently blocked</p>
                        <button class="btn btn-outline-light" data-bs-toggle="modal" data-bs-target="#addBlockModal">
                            <i class="fas fa-plus me-1"></i> Add First IP
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Add IP Modal -->
    <div class="modal fade" id="addBlockModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content bg-dark text-light">
                <div class="modal-header">
                    <h5 class="modal-title">Add IP to Blocklist</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addBlockForm">
                        <div class="mb-3">
                            <label for="ipAddress" class="form-label">IP Address</label>
                            <input type="text" class="form-control bg-dark text-light" 
                                   id="ipAddress" placeholder="e.g., 192.168.1.100" required>
                            <div class="form-text">Enter a valid IPv4 or IPv6 address</div>
                        </div>
                        <div class="mb-3">
                            <label for="blockReason" class="form-label">Reason</label>
                            <textarea class="form-control bg-dark text-light" 
                                     id="blockReason" rows="3" 
                                     placeholder="Why are you blocking this IP?"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" onclick="addToBlocklist()">
                        <i class="fas fa-ban me-1"></i> Block IP
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Confirm Unblock Modal -->
    <div class="modal fade" id="confirmUnblockModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content bg-dark text-light">
                <div class="modal-header">
                    <h5 class="modal-title">Confirm Unblock</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to unblock <strong id="unblockIP">?</strong>?</p>
                    <p class="text-muted small">This will allow the IP to access your systems again.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" id="confirmUnblockBtn">
                        <i class="fas fa-check me-1"></i> Yes, Unblock
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let blocklistData = [];
        let ipToUnblock = '';
        
        async function loadBlocklist() {
            try {
                // In a real implementation, you would fetch from an API
                // For now, we'll use sample data
                const response = await fetch('/api/stats');
                const stats = await response.json();
                
                // Update statistics
                document.getElementById('totalBlocked').textContent = stats.blocked_ips;
                
                // For demo purposes, we'll calculate auto-blocked and today's blocked
                const autoBlocked = Math.floor(stats.blocked_ips * 0.7); // 70% auto-blocked
                const todayBlocked = Math.floor(stats.blocked_ips * 0.2); // 20% blocked today
                
                document.getElementById('autoBlocked').textContent = autoBlocked;
                document.getElementById('todayBlocked').textContent = todayBlocked;
                
                // Load blocklist data
                // In a real implementation, you would have an API endpoint for this
                // For now, we'll generate sample data
                generateSampleBlocklist();
                
            } catch (error) {
                console.error('Error loading blocklist:', error);
                document.getElementById('blocklistBody').innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center text-danger">
                            <i class="fas fa-exclamation-circle me-2"></i>
                            Error loading blocklist: ${error.message}
                        </td>
                    </tr>
                `;
            }
        }
        
        function generateSampleBlocklist() {
            // Sample blocklist data
            blocklistData = [
                {
                    ip_address: '192.168.1.100',
                    reason: 'Multiple SQL injection attempts',
                    blocked_by: 'system',
                    blocked_at: new Date(Date.now() - 3600000).toISOString() // 1 hour ago
                },
                {
                    ip_address: '10.0.0.50',
                    reason: 'Brute force attack on login',
                    blocked_by: 'system',
                    blocked_at: new Date(Date.now() - 7200000).toISOString() // 2 hours ago
                },
                {
                    ip_address: '172.16.0.25',
                    reason: 'Command injection attempt',
                    blocked_by: 'user-quorra',
                    blocked_at: new Date(Date.now() - 86400000).toISOString() // 1 day ago
                },
                {
                    ip_address: '203.0.113.45',
                    reason: 'XSS attack on contact form',
                    blocked_by: 'system',
                    blocked_at: new Date(Date.now() - 172800000).toISOString() // 2 days ago
                }
            ];
            
            updateBlocklistTable();
        }
        
        function updateBlocklistTable() {
            const tbody = document.getElementById('blocklistBody');
            
            if (blocklistData.length === 0) {
                tbody.innerHTML = '';
                document.getElementById('emptyState').style.display = 'block';
                document.getElementById('blocklistTable').style.display = 'none';
                return;
            }
            
            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('blocklistTable').style.display = 'table';
            
            let tableHTML = '';
            
            blocklistData.forEach((block, index) => {
                const time = new Date(block.blocked_at).toLocaleString();
                const blockedBy = block.blocked_by === 'system' ? 
                    '<span class="badge bg-info">System</span>' : 
                    `<span class="badge bg-warning">${block.blocked_by}</span>`;
                
                tableHTML += `
                    <tr id="block-row-${index}">
                        <td>
                            <span class="ip-badge">${block.ip_address}</span>
                        </td>
                        <td>${block.reason}</td>
                        <td>${blockedBy}</td>
                        <td><small>${time}</small></td>
                        <td>
                            <button class="btn btn-sm btn-outline-danger" onclick="confirmUnblock('${block.ip_address}')">
                                <i class="fas fa-unlock me-1"></i> Unblock
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = tableHTML;
        }
        
        async function addToBlocklist() {
            const ipAddress = document.getElementById('ipAddress').value.trim();
            const reason = document.getElementById('blockReason').value.trim();
            
            // Basic IP validation
            const ipRegex = /^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/;
            
            if (!ipRegex.test(ipAddress)) {
                alert('Please enter a valid IPv4 address');
                return;
            }
            
            if (!reason) {
                alert('Please provide a reason for blocking this IP');
                return;
            }
            
            try {
                // In a real implementation, you would call an API endpoint
                // For now, we'll add to our local data
                const newBlock = {
                    ip_address: ipAddress,
                    reason: reason,
                    blocked_by: '{{ username }}',
                    blocked_at: new Date().toISOString()
                };
                
                blocklistData.unshift(newBlock);
                
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('addBlockModal'));
                modal.hide();
                
                // Reset form
                document.getElementById('addBlockForm').reset();
                
                // Update table
                updateBlocklistTable();
                
                // Update statistics
                loadBlocklist();
                
                // Show success message
                showNotification(`IP ${ipAddress} added to blocklist`, 'success');
                
            } catch (error) {
                console.error('Error adding to blocklist:', error);
                showNotification('Failed to add IP to blocklist', 'error');
            }
        }
        
        function confirmUnblock(ipAddress) {
            ipToUnblock = ipAddress;
            document.getElementById('unblockIP').textContent = ipAddress;
            
            const modal = new bootstrap.Modal(document.getElementById('confirmUnblockModal'));
            modal.show();
            
            // Set up confirmation button
            document.getElementById('confirmUnblockBtn').onclick = () => {
                unblockIP(ipAddress);
                modal.hide();
            };
        }
        
        async function unblockIP(ipAddress) {
            try {
                // In a real implementation, you would call an API endpoint
                // For now, we'll remove from our local data
                blocklistData = blocklistData.filter(block => block.ip_address !== ipAddress);
                
                // Update table
                updateBlocklistTable();
                
                // Update statistics
                loadBlocklist();
                
                // Show success message
                showNotification(`IP ${ipAddress} unblocked`, 'success');
                
            } catch (error) {
                console.error('Error unblocking IP:', error);
                showNotification('Failed to unblock IP', 'error');
            }
        }
        
        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show`;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 9999;
                min-width: 300px;
            `;
            notification.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'} me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            // Add to page
            document.body.appendChild(notification);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 5000);
        }
        
        // Auto-refresh every 60 seconds
        setInterval(loadBlocklist, 60000);
        
        // Initial load
        loadBlocklist();
    </script>
</body>
</html>