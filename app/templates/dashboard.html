<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quorra SIEM - Security Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/chart.js" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #fff;
            min-height: 100vh;
        }
        
        .dashboard-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: transform 0.3s ease;
            margin-bottom: 20px;
        }
        
        .dashboard-card:hover {
            transform: translateY(-5px);
        }
        
        .attack-critical { border-left: 4px solid #dc3545; }
        .attack-high { border-left: 4px solid #fd7e14; }
        .attack-medium { border-left: 4px solid #ffc107; }
        .attack-low { border-left: 4px solid #0dcaf0; }
        .attack-info { border-left: 4px solid #6c757d; }
        
        .stat-card {
            text-align: center;
            padding: 20px;
        }
        
        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
        }
        
        .stat-label {
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        .live-badge {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .nav-link {
            color: rgba(255, 255, 255, 0.8) !important;
        }
        
        .nav-link:hover {
            color: #fff !important;
        }
        
        .severity-badge {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: bold;
        }
        
        .severity-critical { background: #dc3545; }
        .severity-high { background: #fd7e14; }
        .severity-medium { background: #ffc107; color: #000; }
        .severity-low { background: #0dcaf0; }
        .severity-info { background: #6c757d; }
        
        .log-entry {
            border-left: 3px solid transparent;
            padding: 10px;
            margin-bottom: 8px;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 5px;
        }
        
        .log-entry:hover {
            background: rgba(255, 255, 255, 0.05);
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">
                <i class="fas fa-shield-alt me-2"></i>
                <span class="fw-bold">QUORRA SIEM</span>
                <span class="badge bg-primary ms-2">v1.0</span>
                <span class="badge bg-success ms-2 live-badge">LIVE</span>
            </a>
            
            <div class="navbar-nav flex-row align-items-center">
                <span class="text-light me-3">
                    <i class="fas fa-user-circle me-1"></i>
                    {{ username }}
                </span>
                <a class="nav-link mx-3 active" href="/dashboard">
                    <i class="fas fa-chart-line me-1"></i> Dashboard
                </a>
                <a class="nav-link mx-3" href="/logs">
                    <i class="fas fa-list me-1"></i> Logs
                </a>
                <a class="nav-link mx-3" href="/attacks">
                    <i class="fas fa-bug me-1"></i> Attacks
                </a>
                <a class="nav-link mx-3" href="/alerts">
                    <i class="fas fa-bell me-1"></i> Alerts
                </a>
                <a class="nav-link mx-3" href="/blocklist">
                    <i class="fas fa-ban me-1"></i> Blocklist
                </a>
                <a class="nav-link mx-3 text-warning" href="/login">
                    <i class="fas fa-sign-out-alt me-1"></i> Logout
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container-fluid py-4">
        <div class="row mb-4">
            <div class="col-12">
                <h1 class="h3 mb-0">
                    <i class="fas fa-tachometer-alt me-2"></i>Security Dashboard
                </h1>
                <p class="text-muted mb-0">Real-time security monitoring for Block Fortress</p>
            </div>
        </div>
        
        <!-- Quick Stats -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="dashboard-card stat-card">
                    <div class="stat-number text-primary" id="totalAttacks">0</div>
                    <div class="stat-label">Total Attacks</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="dashboard-card stat-card">
                    <div class="stat-number text-warning" id="todayAttacks">0</div>
                    <div class="stat-label">Today's Attacks</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="dashboard-card stat-card">
                    <div class="stat-number text-danger" id="blockedIPs">0</div>
                    <div class="stat-label">Blocked IPs</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="dashboard-card stat-card">
                    <div class="stat-number text-success" id="activeAlerts">0</div>
                    <div class="stat-label">Active Alerts</div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <!-- Left Column -->
            <div class="col-lg-8">
                <!-- Attack Chart -->
                <div class="dashboard-card p-4 mb-4">
                    <h5 class="mb-3">
                        <i class="fas fa-chart-bar me-2"></i>Attack Timeline (Last 24 Hours)
                    </h5>
                    <canvas id="attackTimelineChart" height="150"></canvas>
                </div>
                
                <!-- Recent Attacks -->
                <div class="dashboard-card p-4 mb-4">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0">
                            <i class="fas fa-bolt me-2"></i>Recent Attacks
                        </h5>
                        <a href="/attacks" class="btn btn-sm btn-outline-light">View All</a>
                    </div>
                    <div id="recentAttacks">
                        {% if recent_attacks %}
                            {% for attack in recent_attacks %}
                            <div class="attack-{{ attack.severity }} p-3 mb-2 rounded">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <strong>{{ attack.attack_type }}</strong>
                                        <span class="severity-badge severity-{{ attack.severity }} ms-2">{{ attack.severity }}</span>
                                    </div>
                                    <small>{{ attack.detected_at.strftime('%H:%M:%S') }}</small>
                                </div>
                                <div class="small mt-1">
                                    <i class="fas fa-globe me-1"></i> {{ attack.ip_address }}
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <p class="text-muted text-center py-3">No recent attacks</p>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Recent Logs -->
                <div class="dashboard-card p-4">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0">
                            <i class="fas fa-list me-2"></i>Recent Security Logs
                        </h5>
                        <a href="/logs" class="btn btn-sm btn-outline-light">View All</a>
                    </div>
                    <div id="recentLogs">
                        {% if logs %}
                            {% for log in logs %}
                            <div class="log-entry">
                                <div class="d-flex justify-content-between">
                                    <small><strong>{{ log.attack_type }}</strong></small>
                                    <small>{{ log.timestamp.strftime('%H:%M:%S') }}</small>
                                </div>
                                <div class="d-flex justify-content-between mt-1">
                                    <small><code>{{ log.ip_address }}</code></small>
                                    <span class="severity-badge severity-{{ log.severity }}">{{ log.severity }}</span>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <p class="text-muted text-center py-3">No recent logs</p>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Right Column -->
            <div class="col-lg-4">
                <!-- System Status -->
                <div class="dashboard-card p-4 mb-4">
                    <h5 class="mb-3">
                        <i class="fas fa-network-wired me-2"></i>System Status
                    </h5>
                    <div id="systemStatus">
                        <div class="mb-2">
                            <i class="fas fa-circle text-success me-2"></i>
                            <span>Quorra SIEM</span>
                        </div>
                        <div class="mb-2">
                            <i class="fas fa-circle text-warning me-2"></i>
                            <span>Connecting to Block Fortress...</span>
                        </div>
                        <div class="mb-2">
                            <i class="fas fa-circle text-success me-2"></i>
                            <span>Database</span>
                        </div>
                        <div class="mb-2">
                            <i class="fas fa-circle text-success me-2"></i>
                            <span>Rules Engine</span>
                        </div>
                    </div>
                </div>
                
                <!-- Active Alerts -->
                <div class="dashboard-card p-4 mb-4">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0">
                            <i class="fas fa-exclamation-triangle me-2"></i>Active Alerts
                        </h5>
                        <a href="/alerts" class="btn btn-sm btn-outline-light">View All</a>
                    </div>
                    <div id="activeAlertsList">
                        {% if alerts %}
                            {% for alert in alerts %}
                                {% if not alert.read %}
                                <div class="alert alert-{{ 'danger' if alert.severity == 'critical' else 'warning' }} mb-2">
                                    <div class="small">{{ alert.created_at.strftime('%H:%M:%S') }}</div>
                                    <div class="fw-bold">{{ alert.message }}</div>
                                    <button class="btn btn-sm btn-outline-dark mt-2" onclick="acknowledgeAlert({{ alert.id }})">
                                        Acknowledge
                                    </button>
                                </div>
                                {% endif %}
                            {% endfor %}
                        {% else %}
                            <p class="text-muted text-center">No unread alerts</p>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Quick Actions -->
                <div class="dashboard-card p-4">
                    <h5 class="mb-3">
                        <i class="fas fa-cogs me-2"></i>Quick Actions
                    </h5>
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-light" onclick="startMonitoring()" id="monitoringBtn">
                            <i class="fas fa-play me-2"></i>Start Monitoring
                        </button>
                        <button class="btn btn-outline-danger" onclick="stopMonitoring()">
                            <i class="fas fa-stop me-2"></i>Stop Monitoring
                        </button>
                        <button class="btn btn-outline-warning" onclick="exportLogs()">
                            <i class="fas fa-download me-2"></i>Export Logs
                        </button>
                        <a href="/blocklist" class="btn btn-outline-info">
                            <i class="fas fa-ban me-2"></i>Manage Blocklist
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let attackChart;
        let updateInterval;
        
        // Initialize dashboard
        async function loadDashboard() {
            try {
                const response = await fetch('/api/stats');
                const stats = await response.json();
                
                // Update quick stats
                document.getElementById('totalAttacks').textContent = stats.total_attacks;
                document.getElementById('todayAttacks').textContent = stats.recent_attacks;
                document.getElementById('blockedIPs').textContent = stats.blocked_ips;
                document.getElementById('activeAlerts').textContent = stats.total_alerts;
                
                // Update system status
                const systemStatus = document.getElementById('systemStatus');
                systemStatus.innerHTML = `
                    <div class="mb-2">
                        <i class="fas fa-circle ${stats.active_monitoring ? 'text-success' : 'text-danger'} me-2"></i>
                        <span>Quorra SIEM ${stats.active_monitoring ? '(Running)' : '(Stopped)'}</span>
                    </div>
                    <div class="mb-2">
                        <i class="fas fa-circle ${stats.ws_connected ? 'text-success' : 'text-warning'} me-2"></i>
                        <span>Block Fortress ${stats.ws_connected ? '(Connected)' : '(Disconnected)'}</span>
                    </div>
                    <div class="mb-2">
                        <i class="fas fa-circle text-success me-2"></i>
                        <span>Database (${stats.total_logs} logs)</span>
                    </div>
                    <div class="mb-2">
                        <i class="fas fa-circle text-success me-2"></i>
                        <span>Rules Engine (${Object.keys(stats.attack_types || {}).length} patterns)</span>
                    </div>
                `;
                
                // Update monitoring button
                const monitoringBtn = document.getElementById('monitoringBtn');
                if (stats.active_monitoring) {
                    monitoringBtn.innerHTML = '<i class="fas fa-pause me-2"></i>Pause Monitoring';
                    monitoringBtn.onclick = stopMonitoring;
                } else {
                    monitoringBtn.innerHTML = '<i class="fas fa-play me-2"></i>Start Monitoring';
                    monitoringBtn.onclick = startMonitoring;
                }
                
                // Load recent attacks via API
                const attacksResponse = await fetch('/api/attacks');
                const attacks = await attacksResponse.json();
                
                let attacksHTML = '';
                attacks.slice(0, 5).forEach(attack => {
                    const time = new Date(attack.detected_at).toLocaleTimeString();
                    const severityClass = `severity-${attack.severity}`;
                    attacksHTML += `
                        <div class="attack-${attack.severity} p-3 mb-2 rounded">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <strong>${attack.attack_type}</strong>
                                    <span class="severity-badge ${severityClass} ms-2">${attack.severity}</span>
                                </div>
                                <small>${time}</small>
                            </div>
                            <div class="small mt-1">
                                <i class="fas fa-globe me-1"></i> ${attack.ip_address}
                            </div>
                        </div>
                    `;
                });
                document.getElementById('recentAttacks').innerHTML = attacksHTML || 
                    '<p class="text-muted text-center py-3">No recent attacks</p>';
                
                // Load recent logs via API
                const logsResponse = await fetch('/api/logs?per_page=5');
                const logsData = await logsResponse.json();
                
                let logsHTML = '';
                if (logsData.items && logsData.items.length > 0) {
                    logsData.items.forEach(log => {
                        const time = new Date(log.timestamp).toLocaleTimeString();
                        logsHTML += `
                            <div class="log-entry">
                                <div class="d-flex justify-content-between">
                                    <small><strong>${log.attack_type}</strong></small>
                                    <small>${time}</small>
                                </div>
                                <div class="d-flex justify-content-between mt-1">
                                    <small><code>${log.ip_address}</code></small>
                                    <span class="severity-badge severity-${log.severity}">${log.severity}</span>
                                </div>
                            </div>
                        `;
                    });
                } else {
                    logsHTML = '<p class="text-muted text-center py-3">No recent logs</p>';
                }
                document.getElementById('recentLogs').innerHTML = logsHTML;
                
                // Load active alerts via API
                const alertsResponse = await fetch('/api/alerts');
                const alerts = await alertsResponse.json();
                
                let alertsHTML = '';
                const unreadAlerts = alerts.filter(a => !a.read).slice(0, 3);
                
                if (unreadAlerts.length > 0) {
                    unreadAlerts.forEach(alert => {
                        const time = new Date(alert.created_at).toLocaleTimeString();
                        alertsHTML += `
                            <div class="alert alert-${alert.severity === 'critical' ? 'danger' : 'warning'} mb-2">
                                <div class="small">${time}</div>
                                <div class="fw-bold">${alert.message}</div>
                                <button class="btn btn-sm btn-outline-dark mt-2" onclick="acknowledgeAlert(${alert.id})">
                                    Acknowledge
                                </button>
                            </div>
                        `;
                    });
                } else {
                    alertsHTML = '<p class="text-muted text-center">No unread alerts</p>';
                }
                document.getElementById('activeAlertsList').innerHTML = alertsHTML;
                
                // Update chart
                updateChart(stats);
                
            } catch (error) {
                console.error('Error loading dashboard:', error);
            }
        }
        
        function updateChart(stats) {
            const ctx = document.getElementById('attackTimelineChart').getContext('2d');
            
            if (attackChart) {
                attackChart.destroy();
            }
            
            const hourlyData = stats.hourly_distribution || {};
            const labels = Object.keys(hourlyData).reverse();
            const data = Object.values(hourlyData).reverse();
            
            attackChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Attacks',
                        data: data,
                        borderColor: '#0d6efd',
                        backgroundColor: 'rgba(13, 110, 253, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: 'rgba(255, 255, 255, 0.7)'
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: 'rgba(255, 255, 255, 0.7)'
                            }
                        }
                    }
                }
            });
        }
        
        // Control functions
        async function startMonitoring() {
            try {
                const response = await fetch('/api/start_monitoring', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                const result = await response.json();
                alert(result.message);
                loadDashboard();
            } catch (error) {
                console.error('Error starting monitoring:', error);
                alert('Failed to start monitoring');
            }
        }
        
        async function stopMonitoring() {
            try {
                const response = await fetch('/api/stop_monitoring', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                const result = await response.json();
                alert(result.message);
                loadDashboard();
            } catch (error) {
                console.error('Error stopping monitoring:', error);
                alert('Failed to stop monitoring');
            }
        }
        
        async function acknowledgeAlert(alertId) {
            try {
                const response = await fetch(`/api/acknowledge_alert/${alertId}`, {
                    method: 'POST'
                });
                const result = await response.json();
                if (result.success) {
                    loadDashboard();
                }
            } catch (error) {
                console.error('Error acknowledging alert:', error);
            }
        }
        
        function exportLogs() {
            // Open export in new window
            window.open('/api/logs/export?format=json', '_blank');
        }
        
        // Auto-refresh every 10 seconds
        updateInterval = setInterval(loadDashboard, 10000);
        
        // Initial load
        loadDashboard();
        
        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (updateInterval) {
                clearInterval(updateInterval);
            }
        });
    </script>
</body>
</html>